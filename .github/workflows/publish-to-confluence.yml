name: Publish Markdown to Confluence

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    env:
      CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
      CONFLUENCE_USER: ${{ secrets.CONFLUENCE_USER }}
      CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
      CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY }}
      PAGE_TITLE: Docs-as-Code Demo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc jq

      - name: Convert Markdown to HTML
        run: pandoc docs/index.md -f markdown -t html -o page.html

      - name: Get existing Confluence page (if any)
        id: get_page
        run: |
          RESPONSE=$(curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            "$CONFLUENCE_BASE_URL/wiki/rest/api/content?title=$PAGE_TITLE&spaceKey=$CONFLUENCE_SPACE_KEY")

          PAGE_ID=$(echo "$RESPONSE" | jq -r '.results[0].id // empty')
          PAGE_VERSION=$(echo "$RESPONSE" | jq -r '.results[0].version.number // 0')

          echo "page_id=$PAGE_ID" >> $GITHUB_OUTPUT
          echo "page_version=$PAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Create or update page
        run: |
          BODY=$(cat page.html | sed 's/"/\\"/g')

          if [ -z "${{ steps.get_page.outputs.page_id }}" ]; then
            echo "Creating new page"
            curl -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
              -X POST \
              -H "Content-Type: application/json" \
              "$CONFLUENCE_BASE_URL/wiki/rest/api/content" \
              --data "{
                \"type\": \"page\",
                \"title\": \"$PAGE_TITLE\",
                \"space\": { \"key\": \"$CONFLUENCE_SPACE_KEY\" },
                \"body\": {
                  \"storage\": {
                    \"value\": \"$BODY\",
                    \"representation\": \"storage\"
                  }
                }
              }"
          else
            echo \"Updating existing page\"
            NEXT_VERSION=$(( ${{ steps.get_page.outputs.page_version }} + 1 ))
            curl -u \"$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN\" \
              -X PUT \
              -H \"Content-Type: application/json\" \
              \"$CONFLUENCE_BASE_URL/wiki/rest/api/content/${{ steps.get_page.outputs.page_id }}\" \
              --data \"{
                \\\"id\\\": \\\"${{ steps.get_page.outputs.page_id }}\\\",
                \\\"type\\\": \\\"page\\\",
                \\\"title\\\": \\\"$PAGE_TITLE\\\",
                \\\"version\\\": { \\\"number\\\": $NEXT_VERSION },
                \\\"body\\\": {
                  \\\"storage\\\": {
                    \\\"value\\\": \\\"$BODY\\\",
                    \\\"representation\\\": \\\"storage\\\"
                  }
                }
              }\"
          fi
