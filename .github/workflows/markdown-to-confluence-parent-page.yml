name: Publish Markdown to Confluence

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    env:
      CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
      CONFLUENCE_USER: ${{ secrets.CONFLUENCE_USER }}
      CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
      CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY }}
      PARENT_PAGE_ID: ${{ secrets.PARENT_PAGE_ID }}

      # Keep simple for now (no spaces to avoid URL encoding issues)
      PAGE_TITLE: DocsDemo

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install required tools
      - name: Install Pandoc and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      # 3. Convert Markdown to HTML
      - name: Convert Markdown to HTML
        run: |
          pandoc docs/index.md -f markdown -t html -o page.html

      # 4. Look up existing Confluence page
      - name: Look up existing Confluence page
        id: lookup
        run: |
          set -e

          API_URL="${CONFLUENCE_BASE_URL}/wiki/rest/api/content?title=${PAGE_TITLE}&spaceKey=${CONFLUENCE_SPACE_KEY}"

          echo "Looking up page via:"
          echo "$API_URL"

          RESPONSE=$(curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            "$API_URL")

          echo "$RESPONSE" | jq .

          PAGE_ID=$(echo "$RESPONSE" | jq -r '.results[0].id // empty')
          PAGE_VERSION=$(echo "$RESPONSE" | jq -r '.results[0].version.number // 0')

          echo "page_id=$PAGE_ID" >> "$GITHUB_OUTPUT"
          echo "page_version=$PAGE_VERSION" >> "$GITHUB_OUTPUT"

      # 5. Create page if it does not exist
      - name: Create page
        if: steps.lookup.outputs.page_id == ''
        run: |
          jq -n \
            --arg title "$PAGE_TITLE" \
            --arg space "$CONFLUENCE_SPACE_KEY" \
            --arg parent "$PARENT_PAGE_ID" \
            --rawfile body page.html \
          '{
            type: "page",
            title: $title,
            space: { key: $space },
            ancestors: [ { id: $parent } ],
            body: {
              storage: {
              value: $body,
              representation: "storage"
              }
            }
          }' > payload.json


          curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            "$CONFLUENCE_BASE_URL/wiki/rest/api/content" \
            --data @payload.json

      # 6. Update page if it already exists
      - name: Update page
        if: steps.lookup.outputs.page_id != ''
        run: |
          NEXT_VERSION=$(( ${{ steps.lookup.outputs.page_version }} + 1 ))

         jq -n \
          --arg id "${{ steps.lookup.outputs.page_id }}" \
          --arg title "$PAGE_TITLE" \
          --arg parent "$PARENT_PAGE_ID" \
          --argjson version "$NEXT_VERSION" \
          --rawfile body page.html \
          '{
            id: $id,
            type: "page",
            title: $title,
            ancestors: [ { id: $parent } ],
            version: { number: $version },
            body: {
              storage: {
              value: $body,
              representation: "storage"
              }
            }
          }' > payload.json

          curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            -X PUT \
            -H "Content-Type: application/json" \
            "$CONFLUENCE_BASE_URL/wiki/rest/api/content/${{ steps.lookup.outputs.page_id }}" \
            --data @payload.json

      # 7. Final verification (definitive)
      - name: Verify page exists via API
        run: |
          echo "Final verification:"
          curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            "$CONFLUENCE_BASE_URL/wiki/rest/api/content?title=$PAGE_TITLE&expand=space" \
            | jq .
