name: Markdown to Confluence - Page Hierarchy

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    env:
      CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
      CONFLUENCE_USER: ${{ secrets.CONFLUENCE_USER }}
      CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
      CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY }}
      PARENT_PAGE_ID: ${{ secrets.PARENT_PAGE_ID }}
      PAGE_TITLE: DocsPageHierarchyDemo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      - name: Markdown to Confluence - Page Hierarchy
        run: |
          pandoc docs/index.md -f markdown -t html -o page.html

      - name: Look up existing page
        id: lookup
        run: |
          set -e

          API_URL="${CONFLUENCE_BASE_URL}/wiki/rest/api/content?title=${PAGE_TITLE}&spaceKey=${CONFLUENCE_SPACE_KEY}"

          RESPONSE=$(curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            "$API_URL")

          PAGE_ID=$(echo "$RESPONSE" | jq -r '.results[0].id // empty')
          PAGE_VERSION=$(echo "$RESPONSE" | jq -r '.results[0].version.number // 0')

          echo "page_id=$PAGE_ID" >> "$GITHUB_OUTPUT"
          echo "page_version=$PAGE_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create page
        if: steps.lookup.outputs.page_id == ''
        run: |
          jq -n \
            --arg title "$PAGE_TITLE" \
            --arg space "$CONFLUENCE_SPACE_KEY" \
            --arg parent "$PARENT_PAGE_ID" \
            --rawfile body page.html \
            '{
              type: "page",
              title: $title,
              space: { key: $space },
              ancestors: [ { id: $parent } ],
              body: {
                storage: {
                  value: $body,
                  representation: "storage"
                }
              }
            }' > payload.json

          curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            "$CONFLUENCE_BASE_URL/wiki/rest/api/content" \
            --data @payload.json

      - name: Update page
        if: steps.lookup.outputs.page_id != ''
        run: |
          PAGE_ID="${{ steps.lookup.outputs.page_id }}"
          NEXT_VERSION=$(( ${{ steps.lookup.outputs.page_version }} + 1 ))

          jq -n \
            --arg title "$PAGE_TITLE" \
            --arg parent "$PARENT_PAGE_ID" \
            --argjson version "$NEXT_VERSION" \
            --rawfile body page.html \
            --argjson id "$PAGE_ID" \
            '{
              id: $id,
              type: "page",
              title: $title,
              ancestors: [ { id: $parent } ],
              version: { number: $version },
              body: {
                storage: {
                  value: $body,
                  representation: "storage"
                }
              }
            }' > payload.json

          curl -s \
            -u "$CONFLUENCE_USER:$CONFLUENCE_API_TOKEN" \
            -X PUT \
            -H "Content-Type: application/json" \
            "$CONFLUENCE_BASE_URL/wiki/rest/api/content/$PAGE_ID" \
            --data @payload.json
